// ============================================
// COMPONENTS
// ============================================

// --- Spring Timing Functions ---
$spring-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
$spring-gentle: cubic-bezier(0.22, 1, 0.36, 1);
$spring-snappy: cubic-bezier(0.2, 0.9, 0.3, 1.1);
$md3-emphasized: cubic-bezier(0.05, 0.7, 0.1, 1.0);

// --- Header ---

.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  height: var(--header-height);
  background: var(--color-header-bg);
  border-bottom: 1px solid var(--color-header-border);
  backdrop-filter: var(--header-backdrop);
  -webkit-backdrop-filter: var(--header-backdrop);
  box-shadow: var(--header-shadow);
  position: sticky;
  top: 0;
  z-index: 50;
  transition: all 0.3s ease;
}

.header-left {
  flex: 1;
  display: flex;
  align-items: center;
  min-width: 0;
}

.header-center {
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  margin: 0 8px;
  text-align: center;
}

.header-right {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 8px;
  position: relative;
  min-width: 0;
}

.header-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--color-text);
}

.header-subtitle {
  font-size: 10px;
  color: var(--color-text-secondary);
  font-weight: 500;
  transition: opacity 0.2s;
}

.header-btn {
  display: flex;
  align-items: center;
  color: var(--bubble-sent-bg);
  background: transparent;
  border: none;
  cursor: pointer;
  transition: opacity 0.2s;
  white-space: nowrap;
  font-size: 17px;
  font-weight: 500;
  
  &:hover {
    opacity: 0.7;
  }
}

.header-btn-text {
  margin-left: 4px;
}

// --- Skeleton Loader ---

.skeleton-wrapper {
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  width: 100%;
  animation: fadeOut 0.2s ease-out;
}

.skeleton-row {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  width: 100%;
  
  &.skeleton-sent {
    flex-direction: row-reverse;
  }
}

.skeleton-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: rgba(0,0,0,0.06);
  flex-shrink: 0;
  animation: pulse 1.5s infinite ease-in-out;
}

.skeleton-bubble {
  height: 36px;
  border-radius: 18px;
  background: rgba(0,0,0,0.06);
  animation: pulse 1.5s infinite ease-in-out;
  
  &.short { width: 80px; }
  &.medium { width: 160px; }
  &.long { width: 240px; }
}

@keyframes pulse {
  0% { opacity: 0.5; }
  50% { opacity: 0.8; }
  100% { opacity: 0.5; }
}

// --- Avatar ---

.avatar {
  width: 32px;
  height: 32px;
  border-radius: var(--avatar-radius);
  overflow: hidden;
  background-color: #e5e7eb;
  transition: border-radius 0.3s, box-shadow 0.2s, transform 0.2s $spring-bounce;
  border: var(--avatar-border);
  flex-shrink: 0;
  display: block;

  img { 
    width: 100%; 
    height: 100%; 
    object-fit: cover;
    display: block;
  }
  
  &:hover {
    border: var(--avatar-border-hover);
  }
}

.avatar-btn {
  cursor: pointer;
  padding: 0;
  
  &:hover {
    box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.3);
    transform: scale(1.05);
  }
  
  &:active {
    transform: scale(0.98);
  }
}

.avatar-fallback {
  width: 100%;
  height: 100%;
  background: #d1d5db;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #6b7280;
}

.avatar-space {
  width: 32px;
  margin-right: 8px;
  flex-shrink: 0;
  align-self: flex-end;
}

.avatar-spacer {
  width: 32px;
  height: 32px;
}

// --- Bubbles & Layout ---

.bubble-wrapper {
  display: flex;
  align-items: center;
  gap: 8px;
  position: relative;
  width: fit-content;
  max-width: 100%;

  &:hover .desktop-actions {
    opacity: 1;
    pointer-events: auto;
  }
}

.desktop-actions {
  display: flex;
  align-items: center;
  gap: 2px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease-in-out;
}

.action-btn {
  background: transparent;
  border: none;
  color: var(--color-text-secondary);
  padding: 6px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background-color 0.15s, color 0.15s, transform 0.2s $spring-bounce;
  
  &:hover {
    background-color: rgba(0,0,0,0.05);
    color: var(--color-text);
    transform: scale(1.1);
  }
  
  &:active {
    transform: scale(0.92);
  }
  
  &.active {
    color: var(--bubble-sent-bg);
  }
}

.message-stack {
    display: flex;
    flex-direction: column;
    gap: 4px;
    align-items: inherit;
    max-width: 100%;
}

.bubble {
  min-width: 60px;
  padding: 8px 16px;
  border-radius: var(--radius-bubble);
  word-wrap: break-word;
  position: relative;
  font-size: 16px;
  line-height: 1.4;
  transition: border-radius 0.2s, background-color 0.3s, transform 0.2s $spring-bounce, box-shadow 0.2s;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  cursor: default;
  user-select: none;
  width: fit-content;

  &-sent {
    background: var(--bubble-sent-bg);
    color: var(--bubble-sent-text);
    margin-left: auto; 
    border-bottom-right-radius: 4px;
  }

  &-received {
    background: var(--bubble-received-bg);
    color: var(--bubble-received-text);
    margin-right: auto;
    border-bottom-left-radius: 4px;
  }
  
  &.pinned {
    border: 2px solid var(--bubble-sent-bg);
  }
  
  &.long-pressed {
    transform: scale(1.02);
    box-shadow: 0 8px 24px rgba(0,0,0,0.15), 0 4px 8px rgba(0,0,0,0.1);
  }
}

.group-sent {
  &-first { border-bottom-right-radius: var(--radius-bubble-sm); }
  &-middle { border-top-right-radius: var(--radius-bubble-sm); border-bottom-right-radius: var(--radius-bubble-sm); }
  &-last { border-top-right-radius: var(--radius-bubble-sm); border-bottom-right-radius: var(--radius-bubble); }
}

.group-received {
  &-first { border-bottom-left-radius: var(--radius-bubble-sm); }
  &-middle { border-top-left-radius: var(--radius-bubble-sm); border-bottom-left-radius: var(--radius-bubble-sm); }
  &-last { border-top-left-radius: var(--radius-bubble-sm); border-bottom-left-radius: var(--radius-bubble); }
}

.bubble-text {
  white-space: pre-wrap;
  word-wrap: break-word;
  word-break: break-word;
  margin: 0;
  min-width: 20px;
  line-height: 1.625;
}

.bubble-attachments {
  margin-bottom: 8px;
  position: relative;
  border-radius: 8px;
  overflow: hidden;
  max-width: 100%;
}

.attachment-img,
.attachment-video {
  width: 100%;
  height: auto;
  display: block;
  max-height: 400px;
  object-fit: contain;
  background: #000;
}

.attachment-img {
  object-fit: cover;
  background: transparent;
  transition: transform 0.3s $spring-gentle;
  cursor: pointer;
  
  &:hover {
    transform: scale(1.02);
  }
}

// --- Reactions ---

.reaction-pill {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  background: var(--color-bg);
  border: 1px solid rgba(0,0,0,0.08);
  border-radius: 12px;
  font-size: 12px;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  transition: transform 0.2s $spring-bounce;

  &:hover { transform: scale(1.08); }
  
  &.active {
    border-color: var(--bubble-sent-bg);
    background: rgba(0, 122, 255, 0.1);
  }
}

.reactions-container {
  margin-top: 4px;
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  user-select: none;
  width: 100%;
  
  &.justify-end {
    justify-content: flex-end;
  }
}

.reaction-btn {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  border-radius: 9999px;
  border: 1px solid #e5e7eb;
  background: var(--color-bg);
  cursor: pointer;
  transition: transform 0.2s $spring-bounce, background-color 0.15s, border-color 0.15s, box-shadow 0.15s;
  
  &:hover {
    transform: scale(1.08);
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  
  &:active {
    transform: scale(0.92);
  }
  
  &.active {
    border-color: #60a5fa;
    background: #eff6ff;
    box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
  }
  
  &.just-added {
    animation: reactionPop 0.3s $spring-bounce;
  }
}

.reaction-emoji {
  font-size: 14px;
  transition: transform 0.2s $spring-bounce;
  
  .reaction-btn:hover & {
    transform: scale(1.15);
  }
}

.reaction-count {
  font-size: 12px;
  font-weight: 700;
  color: #6b7280;
  transition: color 0.15s;
  
  .reaction-btn.active & {
    color: #3b82f6;
  }
}

.reaction-picker {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px;
  background: var(--color-bg);
  border-radius: 9999px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.15);
  border: 1px solid var(--input-border);
  animation: popIn 0.2s $spring-bounce forwards;
  transform-origin: center bottom;
  z-index: 10;
}

.reaction-option {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 9999px;
  font-size: 20px;
  line-height: 1;
  background: transparent;
  border: none;
  cursor: pointer;
  transition: background-color 0.15s, transform 0.2s $spring-bounce;
  
  &:hover {
    background: rgba(0, 0, 0, 0.05);
    transform: scale(1.15);
  }
  
  &:active {
    transform: scale(0.95);
  }
}

// --- Inputs ---

.composer-wrapper {
  background: transparent;
  position: relative;
}

.input-row {
  display: flex;
  align-items: center; 
  gap: 8px;
  padding: 8px 12px;
  padding-bottom: max(12px, env(safe-area-inset-bottom));
  background: transparent;

  &::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(
      to right,
      transparent,
      var(--input-border) 20%,
      var(--input-border) 80%,
      transparent
    );
    opacity: 0.5;
  }
}

.input-container {
  display: flex;
  align-items: center; 
  gap: 8px;
  padding: 6px 12px; 
  background: var(--input-bg);
  border: 1px solid var(--input-border);
  border-radius: 20px; 
  flex: 1;
  transition: background-color 0.3s, border-color 0.2s, box-shadow 0.2s;
  
  &:focus-within {
    border-color: var(--bubble-sent-bg);
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
  }

  @media (max-width: 640px) {
    gap: 4px;
    padding: 6px 8px;
  }
}

.outside-plus-btn {
    background: #e5e7eb;
    color: #6b7280;
    width: 32px;
    height: 32px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    
    &:hover {
        background: #d1d5db;
        color: #4b5563;
    }

    svg {
        width: 18px;
        height: 18px;
    }
}

.message-input {
  flex: 1;
  min-height: 36px;
  max-height: 120px;
  padding: 8px 4px;
  border: none;
  border-radius: 0;
  background: transparent;
  color: var(--color-text);
  font-family: inherit;
  font-size: 16px;
  resize: none;
  outline: none;
  line-height: 1.4;
  min-width: 0; 

  &::placeholder {
    color: var(--color-text-secondary);
  }
}

.icon-btn {
  padding: 8px;
  border-radius: 50%;
  color: var(--bubble-sent-bg);
  transition: background-color 0.15s, transform 0.2s $spring-bounce;
  display: flex;
  align-items: center;
  justify-content: center;
  background: transparent;
  border: none;
  cursor: pointer;
  flex-shrink: 0;

  &:hover { 
    background-color: rgba(0,0,0,0.05);
    transform: scale(1.08);
  }
  
  &:active {
    transform: scale(0.92);
  }

  @media (max-width: 640px) {
    padding: 6px;
    width: 32px;
    height: 32px;

    svg {
        width: 20px;
        height: 20px;
    }
  }
}

.emoji-sticker-btn {
  color: var(--bubble-sent-bg);
  
  &:hover {
    color: var(--bubble-sent-bg);
  }
}

.send-btn-outside { display: none !important; }
.send-btn-inside { display: flex !important; }

.send-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--bubble-sent-bg);
  color: #ffffff;
  display: flex;
  align-items: center;
  justify-content: center;
  border: none;
  cursor: pointer;
  transition: transform 0.2s $spring-bounce, opacity 0.15s, box-shadow 0.15s, background-color 0.2s;
  box-shadow: none;
  flex-shrink: 0;
  position: relative;
  overflow: hidden;
  
  .send-btn-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s $spring-bounce;
  }
  
  &:hover:not(:disabled) {
    transform: scale(1.05);
  }
  
  &:active:not(:disabled) {
    transform: scale(0.95);
  }
  
  &:disabled {
    opacity: 0;
    pointer-events: none;
  }
  
  &.send-btn--sending {
    .send-btn-icon {
      animation: md3SendBtnActivate 0.5s $spring-bounce;
    }
  }

  &.send-btn--error {
    animation: md3ErrorShake 0.6s ease-out;
    background: #ef4444;
  }
}

@keyframes md3SendBtnActivate {
  0% { transform: scale(1) rotate(0deg); }
  30% { transform: scale(0.85) rotate(-15deg); }
  60% { transform: scale(1.1) rotate(5deg); }
  80% { transform: scale(0.98) rotate(-2deg); }
  100% { transform: scale(1) rotate(0deg); }
}

@keyframes md3ErrorShake {
  0%, 100% { transform: translateX(0); }
  10% { transform: translateX(-8px); }
  20% { transform: translateX(7px); }
  30% { transform: translateX(-6px); }
  40% { transform: translateX(5px); }
  50% { transform: translateX(-3px); }
  60% { transform: translateX(2px); }
  70% { transform: translateX(-1px); }
}

@keyframes reactionPop {
  0% { transform: scale(1); }
  50% { transform: scale(1.25); }
  100% { transform: scale(1); }
}

// ============================================
// MATERIAL DESIGN 3 THEME OVERRIDES
// ============================================

[data-theme="material"] {
  .header {
    background: var(--md3-surface-variant, #E7E0EC);
    border-bottom: none;
    box-shadow: none;
    
    .header-title {
      font-weight: 500;
      letter-spacing: 0;
    }
    
    .header-subtitle {
      font-size: 12px;
      color: var(--md3-on-surface-variant, #49454F);
    }
  }
  
  .composer-wrapper {
    background: transparent;
  }
  
  .input-row {
    display: flex;
    align-items: center; 
    gap: 12px;
    padding: 8px 12px;
    padding-bottom: max(12px, env(safe-area-inset-bottom));
    background: transparent;
    
    &::before {
      background: linear-gradient(
        to right,
        transparent,
        var(--md3-outline-variant, #CAC4D0) 15%,
        var(--md3-outline-variant, #CAC4D0) 85%,
        transparent
      );
      opacity: 0.6;
    }
  }
  
  .input-container {
    background: var(--md3-surface, #FEF7FF);
    border: 1px solid var(--md3-outline, #79747E);
    border-radius: 28px;
    padding: 8px 12px;
    gap: 4px;
    flex: 1;
    display: flex;
    flex-direction: row; 
    flex-wrap: wrap;     
    align-items: center;
    
    &:focus-within {
      border-color: var(--md3-primary, #6750A4);
      border-width: 2px;
      padding: 7px 11px;
      box-shadow: none;
    }
  }
  
  .message-input {
    background: transparent;
    border: none;
    border-radius: 0;
    padding: 8px 4px;
    font-size: 16px;
    width: 100%;
    line-height: 1.5;
    margin: 0;
    
    &:focus {
      border: none;
      box-shadow: none;
      padding: 8px 4px;
    }
    
    &::placeholder {
      color: var(--md3-on-surface-variant, #49454F);
    }
  }
  
  .file-preview-inline {
    width: 100%;
    display: flex;
    gap: 8px;
    padding-bottom: 8px;
    overflow-x: auto;
    order: -1;
  }

  .send-btn-inside { display: none !important; }
  .send-btn-outside { display: flex !important; }
  
  .send-btn {
    width: 56px;
    height: 56px;
    border-radius: 16px;
    background: var(--md3-primary, #6750A4);
    transition: all 0.25s $md3-emphasized;
    flex-shrink: 0;
    
    &:hover:not(:disabled) {
      transform: scale(1.02);
      border-radius: 50%;
    }
    
    &:active:not(:disabled) {
      transform: scale(0.95);
    }
    
    &:disabled {
      background: var(--md3-on-surface-variant, #49454F);
      color: var(--md3-surface, #FEF7FF);
      opacity: 0.38;
      box-shadow: none;
    }
  }
  
  .icon-btn {
    border-radius: 50%;
    color: var(--md3-on-surface-variant, #49454F);
    width: 40px;
    height: 40px;
    
    &:hover {
      background: rgba(103, 80, 164, 0.08);
    }
    
    &:active {
      background: rgba(103, 80, 164, 0.12);
    }
  }
  
  .emoji-sticker-btn {
    &:hover {
      color: var(--md3-primary, #6750A4);
    }
  }
  
  .message-stack {
    display: flex;
    flex-direction: column;
    width: fit-content;
  }

  .bubble {
    width: fit-content;
    &.connected-bottom {
        width: 100%;
    }

    &.bubble-sent {
      border-radius: 20px 20px 4px 20px;
    }
    
    &.bubble-received {
      border-radius: 20px 20px 20px 4px;
    }
    
    //grouped sent messages
    &.group-sent-first {
      border-radius: 20px 20px 10px 10px;
    }
    
    &.group-sent-middle {
      border-radius: 10px;
    }
    
    &.group-sent-last {
      border-radius: 10px 10px 20px 20px;
    }
    
    //grouped received messages
    &.group-received-first {
      border-radius: 20px 20px 10px 10px;
    }
    
    &.group-received-middle {
      border-radius: 10px;
    }
    
    &.group-received-last {
      border-radius: 10px 10px 20px 20px;
    }
  }
  
  .reaction-btn {
    border-radius: 8px;
    background: var(--md3-surface-variant, #E7E0EC);
    border: none;
    
    &.active {
      background: var(--md3-primary-container, #EADDFF);
      border: none;
    }
    
    &:hover {
      background: rgba(103, 80, 164, 0.12);
    }
  }
  
  .avatar,
  .avatar.avatar-btn,
  button.avatar-btn {
    border-radius: 10px !important;
    overflow: hidden;
    
    img {
      border-radius: 10px !important;
    }
    
    &:hover {
      box-shadow: 0 0 0 2px rgba(103, 80, 164, 0.3);
    }
  }
  
  .avatar-fallback {
    border-radius: 10px !important;
  }
  
  .avatar-space .avatar,
  .reaction-sheet-avatar {
    border-radius: 10px !important;
    
    img {
      border-radius: 10px !important;
    }
  }
  
  .avatar-grid .avatar-option {
    border-radius: 10px;
    
    img {
      border-radius: 10px;
    }
  }
  
  .header-btn {
    border-radius: 20px;
    padding: 8px 16px;
    background: transparent;
    
    &:hover {
      background: rgba(103, 80, 164, 0.08);
    }
  }
  
  .file-preview-container {
    background: var(--md3-surface-variant, #E7E0EC);
    border-top: none;
  }
  
  .file-preview-item {
    border-radius: 12px;
    border: 1px solid var(--md3-outline-variant, #CAC4D0);
  }

  .reply-preview {
    background: var(--md3-surface-variant, #E7E0EC);
    border-top: none;
    border-radius: 20px 20px 0px 0px;
  }
  
  .new-messages-indicator {
    border-radius: 16px;
    background: var(--md3-primary, #6750A4);
    box-shadow: 0 2px 6px 0 rgba(0,0,0,0.15), 0 1px 2px 0 rgba(0,0,0,0.3);
    font-weight: 500;
    
    &:hover {
      box-shadow: 0 4px 8px 0 rgba(0,0,0,0.15), 0 2px 4px 0 rgba(0,0,0,0.3);
    }
  }
  
  .toast {
    border-radius: 4px;
    background: #313033;
    box-shadow: 0 3px 5px -1px rgba(0,0,0,0.2), 0 6px 10px 0 rgba(0,0,0,0.14), 0 1px 18px 0 rgba(0,0,0,0.12);
  }
  
  .reaction-wrapper {
    border-radius: 28px;
    background: var(--md3-surface, #FEF7FF);
    border: none;
    box-shadow: 0 2px 6px 0 rgba(0,0,0,0.15), 0 1px 2px 0 rgba(0,0,0,0.3);
    
    &.expanded {
      border-radius: 28px;
    }
  }
  
  .picker-tabs {
    background: var(--md3-surface-variant, #E7E0EC);
    border-bottom: none;
  }
  
  .picker-tab {
    border-radius: 16px;
    
    &.active {
      background: var(--md3-primary-container, #EADDFF);
    }
  }
  
  .reaction-sheet {
    border-radius: 28px 28px 0 0;
    background: var(--md3-surface, #FEF7FF);
  }
  
  .reaction-sheet-handle-bar {
    background: var(--md3-outline-variant, #CAC4D0);
    width: 32px;
    height: 4px;
    border-radius: 2px;
  }
  
  .reaction-sheet-footer {
    background: transparent;
    border-top: none;
  }
  
  .action-btn-sheet {
    border-radius: 20px;
    border: 1px solid var(--md3-outline, #79747E);
    background: transparent;
    
    &.active {
      background: var(--md3-primary, #6750A4);
      border-color: var(--md3-primary, #6750A4);
    }
  }
  
  .delete-btn {
    border-radius: 20px;
    background: #B3261E;
    
    &:hover {
      background: #8C1D18;
    }
  }
  
  .pinned-section {
    background: var(--md3-surface-variant, #E7E0EC);
    border-radius: 16px;
    margin: 8px;
    padding: 12px;
  }
  
  .pinned-header {
    color: var(--md3-on-surface-variant, #49454F);
  }
  
  .pinned-divider {
    background: var(--md3-outline-variant, #CAC4D0);
  }
  
  .gif-picker {
    border-radius: 28px 28px 0 0;
    background: var(--md3-surface, #FEF7FF);
  }
  
  .gif-picker-search input {
    border-radius: 28px;
    border: 1px solid var(--md3-outline, #79747E);
    background: var(--md3-surface, #FEF7FF);
    
    &:focus {
      border-color: var(--md3-primary, #6750A4);
      border-width: 2px;
    }
  }

  .admin-panel {
    border-radius: 28px 28px 0 0;
    background: var(--md3-surface, #FEF7FF);
  }
  
  .admin-panel-handle-bar {
    background: var(--md3-outline-variant, #CAC4D0);
  }

  .avatar-picker {
    border-radius: 28px;
    background: var(--md3-surface, #FEF7FF);
    border: none;
    box-shadow: 0 2px 6px 0 rgba(0,0,0,0.15), 0 1px 2px 0 rgba(0,0,0,0.3);
  }
  
  .lightbox {
    background: rgba(0, 0, 0, 0.32);
  }
  
  .lightbox-close {
    border-radius: 50%;
    background: var(--md3-surface, #FEF7FF);
    color: var(--md3-on-surface-variant, #49454F);
  }
  
  .skeleton-bubble {
    border-radius: 20px;
    background: var(--md3-surface-variant, #E7E0EC);
  }
  .skeleton-avatar {
     border-radius: 8px;
  }
}